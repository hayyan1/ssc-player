<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشغل TOD TV - الترجمة العربية</title>
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.15.3/dist/shaka-player.compiled.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script>
     const playerConfig = {
        manifestUri: 'https://todtv-live-ent-prod.akamaized.net/Content/Channel/svc-spo-hd-39-dt/DASH/hdntl=exp=1756186665~acl=*%2fContent%2fChannel%2fsvc-spo-hd-39-dt%2fDASH%2f*~id=381206cb-5517-41d5-aa68-c73d921b73b7~data=hdntl,aXA9MjYwNzo3NDA6MjQ6MjAwMzoxNTRjOjY3OGU6MmNkODpiZjc4~hmac=2fa040785842fda3b662e60899c2962e4bced735ab03c2aaadcf9c1ec9c16b8d/playlist_tv.mpd',
      drmKeysString: 'f1dac2f937c9338f8e7c33963d06c489:8ab19f639fe1552c7463f4b978c41c9d',
      referrer: 'https://www.tod.tv/',
      defaultQuality: 'auto',
      defaultAudio: 'none',
      defaultSubtitle: 'ar'
    };
    
    // معالجة مفاتيح DRM
    playerConfig.drmKeys = {};
    const drmPairs = playerConfig.drmKeysString
      .split(/[\n,]/)
      .map(pair => pair.trim())
      .filter(pair => pair.includes(':'));
    
    drmPairs.forEach(pair => {
      const [keyId, keyValue] = pair.split(':').map(part => part.trim());
      if (keyId && keyValue) {
        playerConfig.drmKeys[keyId] = keyValue;
      }
    });

    const logoConfig = {
      url: '',
      position: { left: '20px', bottom: '20px' },
      size: '100px',
      opacity: 0.8,
      visible: false
    };
  </script>

  <style>
    :root {
      --primary-color: #ff3d3d;
      --secondary-color: #2a2a2a;
      --text-color: #ffffff;
      --hover-color: rgba(255, 255, 255, 0.15);
      --control-bg: rgba(20, 20, 20, 0.95);
      --progress-bg: rgba(255, 255, 255, 0.25);
      --progress-buffered: rgba(255, 255, 255, 0.1);
      --border-radius: 20px;
      --transition-speed: 0.2s;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --glow: 0 0 8px rgba(255, 61, 61, 0.6);
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: black;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .video-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    video {
      width: 100% !important;
      height: 100% !important;
      object-fit: contain !important;
      transform-origin: center center;
      transition: transform 0.3s ease;
    }

    video:-webkit-full-screen {
      object-fit: contain !important;
      transform: none !important;
    }
    
    video:-moz-full-screen {
      object-fit: contain !important;
      transform: none !important;
    }
    
    video:-ms-fullscreen {
      object-fit: contain !important;
      transform: none !important;
    }
    
    video:fullscreen {
      object-fit: contain !important;
      transform: none !important;
    }

    video::-webkit-media-controls {
      display: none !important;
    }

    /* إعدادات الترجمة */
    video::cue {
      background-color: rgba(0, 0, 0, 0.8) !important;
      color: white !important;
      font-size: 18px !important;
      font-family: Arial, sans-serif !important;
      font-weight: bold !important;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;
      line-height: 1.4 !important;
      padding: 4px 8px !important;
      border-radius: 4px !important;
      white-space: pre-line !important;
    }

    /* للمتصفحات المختلفة */
    video::-webkit-media-text-track-display {
      background-color: rgba(0, 0, 0, 0.8) !important;
      color: white !important;
      font-size: 18px !important;
      font-family: Arial, sans-serif !important;
      font-weight: bold !important;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;
      padding: 4px 8px !important;
      border-radius: 4px !important;
    }

    video::-moz-cue {
      background-color: rgba(0, 0, 0, 0.8) !important;
      color: white !important;
      font-size: 18px !important;
      font-family: Arial, sans-serif !important;
      font-weight: bold !important;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8) !important;
      padding: 4px 8px !important;
      border-radius: 4px !important;
    }

    .logo {
      position: absolute;
      z-index: 999;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
      transition: all 0.3s ease;
    }

    /* عنصر الترجمة المخصص */
    .custom-subtitle {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 20px;
      font-family: Arial, sans-serif;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      padding: 8px 16px;
      border-radius: 6px;
      text-align: center;
      max-width: 80%;
      z-index: 1000;
      display: none;
      white-space: pre-line;
      line-height: 1.4;
    }

    .play-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      cursor: pointer;
    }

    .play-overlay-btn {
      width: 80px;
      height: 80px;
      background-color: var(--primary-color);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 36px;
      color: white;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
    }

    .play-overlay-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 30px rgba(255, 61, 61, 0.7);
    }

    .custom-controls {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%) translateY(100%);
      background: rgba(0, 0, 0, 0.7) !important;
      padding: 8px 15px;
      display: inline-flex;
      flex-direction: column;
      z-index: 1000;
      opacity: 0;
      border-radius: var(--border-radius);
      transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .size-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 5px;
      z-index: 1000;
      opacity: 0;
      transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
    }

    .size-controls button {
      width: 36px;
      height: 36px;
      font-size: 14px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .size-controls button:hover {
      background-color: var(--primary-color);
      transform: scale(1.1);
    }

    .controls-visible {
      opacity: 1 !important;
      transform: translateX(-50%) translateY(0);
      pointer-events: all;
    }

    .size-controls-visible {
      opacity: 1 !important;
      pointer-events: all;
    }

    .controls-row {
      display: flex;
      align-items: center;
      width: auto;
      gap: 8px;
    }

    .control-icons-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button {
      padding: 8px;
      font-size: 16px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background-color: var(--hover-color);
      color: var(--text-color);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      outline: none;
      transition: all var(--transition-speed) ease;
      box-shadow: var(--shadow);
    }

    button:focus {
      background-color: var(--primary-color);
      transform: scale(1.15);
      box-shadow: var(--glow);
    }

    button:hover {
      background-color: var(--primary-color);
      transform: scale(1.15);
      box-shadow: var(--glow);
    }

    .menu-icon {
      width: 36px !important;
      height: 36px !important;
      padding: 8px !important;
      border-radius: 50% !important;
      background-color: var(--hover-color) !important;
      color: var(--text-color) !important;
      border: none !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      font-size: 16px !important;
      transition: all var(--transition-speed) ease !important;
      box-shadow: var(--shadow) !important;
    }

    .menu-icon:hover,
    .menu-icon:focus {
      background-color: var(--primary-color) !important;
      transform: scale(1.15) !important;
      box-shadow: var(--glow) !important;
    }

    .quality-btn {
      width: auto !important;
      min-width: 70px;
      padding: 8px 12px !important;
      border-radius: 20px !important;
      justify-content: space-between !important;
    }

    .quality-btn .quality-text {
      margin-left: 5px;
      font-size: 12px;
    }

    .quality-btn .quality-icon {
      margin-right: 5px;
    }

    .progress-container {
      flex-grow: 1;
      height: 5px;
      min-width: 100px;
      background-color: var(--progress-buffered);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(to right, var(--primary-color), #ff6b6b);
      border-radius: 3px;
      width: 0%;
      position: relative;
      transition: width 0.1s linear;
      z-index: 2;
    }

    .play-pause-btn {
      width: 40px;
      height: 40px;
      font-size: 18px;
      background-color: var(--primary-color);
      box-shadow: var(--glow);
    }

    .time-display {
      color: var(--text-color);
      font-size: 13px;
      font-family: monospace;
      min-width: 50px;
      text-align: center;
    }

    .live-indicator {
      background-color: var(--primary-color);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: bold;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 0.8; }
      50% { opacity: 1; }
      100% { opacity: 0.8; }
    }

    .custom-select {
      position: relative;
    }

    .custom-select-options {
      display: none;
      position: absolute;
      bottom: 40px;
      right: 0;
      background-color: var(--control-bg);
      border-radius: var(--border-radius);
      min-width: 140px;
      z-index: 1001;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: var(--shadow);
      transform: translateY(10px);
      opacity: 0;
      transition: all var(--transition-speed) ease;
    }

    .custom-select-options.show {
      display: block;
      transform: translateY(0);
      opacity: 1;
    }

    .custom-select-option {
      padding: 8px 12px;
      cursor: pointer;
      color: var(--text-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all var(--transition-speed) ease;
      font-size: 13px;
    }

    .custom-select-option:hover {
      background-color: var(--primary-color);
    }

    .custom-select-option.selected::after {
      content: '\f00c';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      margin-left: 8px;
    }

    .quality-icon {
      margin-right: 5px;
    }
    .auto-icon { color: #aaa; }
    .sd-icon { color: #4CAF50; }
    .hd-icon { color: #2196F3; }
    .fhd-icon { color: #FF9800; }
    .uhd-icon { color: #F44336; }

    @media (max-width: 768px) {
      .play-overlay-btn {
        width: 100px;
        height: 100px;
        font-size: 48px;
      }

      .custom-controls {
        width: 95%;
        left: 2.5%;
        transform: translateY(100%);
        padding: 10px;
        justify-content: center;
      }
      
      .controls-visible {
        transform: translateY(0);
      }
      
      .controls-row {
        flex-wrap: wrap;
        justify-content: center;
        gap: 5px;
      }
      
      .progress-container {
        order: 2;
        width: 100%;
        margin: 5px 0;
      }
      
      .control-button {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      
      .play-pause-btn {
        width: 45px;
        height: 45px;
      }
      
      .size-controls {
        top: 5px;
        right: 5px;
      }
      
      .size-controls button {
        width: 32px;
        height: 32px;
        font-size: 12px;
      }

      .quality-btn {
        min-width: 60px;
        padding: 6px 8px !important;
      }
      
      .quality-btn .quality-text {
        margin-left: 3px;
        font-size: 11px;
      }

      .custom-subtitle {
        bottom: 100px;
        font-size: 16px;
        padding: 6px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="video-container">
    <video id="video" playsinline></video>
    <img src="" alt="Logo" class="logo" id="logo">
    <div class="custom-subtitle" id="custom-subtitle"></div>
  </div>

  <div class="play-overlay" id="play-overlay">
    <div class="play-overlay-btn">
      <i class="fas fa-play"></i>
    </div>
  </div>

  <div class="size-controls" id="size-controls">
    <button id="zoom-in-btn" title="تكبير"><i class="fas fa-search-plus"></i></button>
    <button id="zoom-out-btn" title="تصغير"><i class="fas fa-search-minus"></i></button>
    <button id="reset-zoom-btn" title="إعادة الضبط"><i class="fas fa-undo"></i></button>
  </div>

  <div class="custom-controls" id="custom-controls">
    <div class="controls-row">
      <button id="play-pause-btn" class="play-pause-btn" title="تشغيل/إيقاف">
        <i class="fas fa-play"></i>
      </button>
      
      <div class="time-display" id="time-display">LIVE</div>
      <span class="live-indicator">مباشر</span>
      
      <div class="progress-container" id="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      
      <button id="sound-btn" title="الصوت">
        <i class="fas fa-volume-up"></i>
      </button>
      
      <div class="custom-select" id="audio-select">
        <button class="menu-icon" title="الصوت المصاحب">
          <i class="fas fa-music"></i>
        </button>
        <div class="custom-select-options" id="audio-options">
          <div class="custom-select-option" data-value="none">بدون صوت مصاحب</div>
        </div>
      </div>
      
      <div class="custom-select" id="subtitle-select">
        <button class="menu-icon" title="الترجمة">
          <i class="fas fa-closed-captioning"></i>
        </button>
        <div class="custom-select-options" id="subtitle-options">
          <div class="custom-select-option" data-value="none">بدون ترجمة</div>
        </div>
      </div>
      
      <div class="custom-select" id="quality-select">
        <button class="menu-icon quality-btn" title="جودة الفيديو">
          <i class="fas fa-tv quality-icon auto-icon" id="current-quality-icon"></i>
          <span class="quality-text" id="current-quality-text">Auto</span>
        </button>
        <div class="custom-select-options" id="quality-options">
          <div class="custom-select-option" data-value="auto">
            <i class="fas fa-tv quality-icon auto-icon"></i>
            Auto
          </div>
        </div>
      </div>
      
      <button id="fullscreen-btn" title="شاشة كاملة">
        <i class="fas fa-expand"></i>
      </button>
    </div>
  </div>

  <script>
    // متغيرات التكبير
    let zoomLevel = 1;
    const ZOOM_STEP = 0.02;
    const MAX_ZOOM = 2;
    const MIN_ZOOM = 0.5;
    const DEFAULT_MOBILE_ZOOM = 1.15;

    // متغيرات التحكم
    let controlsTimer;
    let isPlaying = false;
    let player;

    function isMobileWithZoom() {
      const isLargeScreen = window.innerWidth >= 1024;
      const isSmartTV = /Android TV|AppleTV|SmartTV|GoogleTV|CrKey|Kylo|Viera|NetCast|Roku|HbbTV|Opera TV|POV_TV|NETTV|InettvBrowser|WebTV|PuffinTV/i.test(navigator.userAgent);
      const hasRemoteControl = /TV|CrKey|AFT[A-Za-z]|AFTM|AFTT|AFTB/i.test(navigator.userAgent);
      
      if (isSmartTV || isLargeScreen || hasRemoteControl) {
        return false;
      }
      
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|Windows Phone|Mobile/i.test(navigator.userAgent);
    }

    function updateVideoSize() {
      const video = document.getElementById('video');
      if (isMobileWithZoom()) {
        video.style.transform = `scaleX(${zoomLevel})`;
      } else {
        video.style.transform = 'none';
      }
    }

    function initLogo() {
      const logo = document.getElementById('logo');
      
      if (logoConfig.visible && logoConfig.url) {
        logo.src = logoConfig.url;
        logo.style.left = logoConfig.position.left;
        logo.style.bottom = logoConfig.position.bottom;
        logo.style.width = logoConfig.size;
        logo.style.opacity = logoConfig.opacity;
        logo.style.display = 'block';
      } else {
        logo.style.display = 'none';
      }
    }

    function showControls() {
      const controls = document.getElementById('custom-controls');
      const sizeControls = document.getElementById('size-controls');
      
      controls.classList.add('controls-visible');
      if (isMobileWithZoom()) {
        sizeControls.classList.add('size-controls-visible');
      }
      
      // إخفاء التحكم بعد 3 ثوان
      clearTimeout(controlsTimer);
      if (isPlaying) {
        controlsTimer = setTimeout(() => {
          controls.classList.remove('controls-visible');
          sizeControls.classList.remove('size-controls-visible');
        }, 3000);
      }
    }

    function hideControls() {
      const controls = document.getElementById('custom-controls');
      const sizeControls = document.getElementById('size-controls');
      
      controls.classList.remove('controls-visible');
      sizeControls.classList.remove('size-controls-visible');
    }

    function formatTime(seconds) {
      if (isNaN(seconds)) return "LIVE";
      const hours = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = Math.floor(seconds % 60);
      if (hours > 0) {
        return `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function updateProgress() {
      const video = document.getElementById('video');
      const progressBar = document.getElementById('progress-bar');
      const timeDisplay = document.getElementById('time-display');
      
      if (video.duration) {
        const progress = (video.currentTime / video.duration) * 100;
        progressBar.style.width = progress + '%';
        timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
      } else {
        timeDisplay.textContent = "LIVE";
      }
    }

    async function initPlayer() {
      // تهيئة الشعار
      initLogo();

      // تطبيق التكبير للأجهزة المحمولة
      if (isMobileWithZoom()) {
        zoomLevel = DEFAULT_MOBILE_ZOOM;
        updateVideoSize();
        document.getElementById('size-controls').style.display = 'flex';
      } else {
        zoomLevel = 1;
        updateVideoSize();
        document.getElementById('size-controls').style.display = 'none';
      }

      const video = document.getElementById('video');
      player = new shaka.Player();
      await player.attach(video);
      window.player = player;

      // تكوين المشغل مع Referrer
      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
            type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
          request.headers['Referer'] = playerConfig.referrer;
        }
      });

      // تكوين DRM
      if (Object.keys(playerConfig.drmKeys).length > 0) {
        player.configure({ 
          drm: { 
            clearKeys: playerConfig.drmKeys 
          },
          streaming: {
            bufferingGoal: 5,
            rebufferingGoal: 15,
            stallThreshold: 0.5,
            bufferBehind: 15
          },
          textDisplayer: {
            captionsUpdatePeriod: 0.25
          }
        });
      }

      try {
        await player.load(playerConfig.manifestUri);
        console.log("تم تحميل الفيديو بنجاح");
        
        // إخفاء overlay التشغيل
        document.getElementById('play-overlay').style.display = 'none';
        showControls();

        // إعداد الترجمة العربية
        const textTracks = player.getTextLanguagesAndRoles();
        console.log("مسارات الترجمة المتاحة:", textTracks);
        
        setupSubtitles(textTracks);
        setupQualityOptions();
        setupAudioOptions();

      } catch (error) {
        console.error("خطأ في تحميل المشغل:", error);
      }
    }

    function setupSubtitles(textTracks) {
      const subtitleOptions = document.getElementById("subtitle-options");
      subtitleOptions.innerHTML = '';
      
      // إضافة خيار "بدون ترجمة"
      const noneOption = document.createElement("div");
      noneOption.className = "custom-select-option";
      noneOption.dataset.value = "none";
      noneOption.textContent = "بدون ترجمة";
      noneOption.addEventListener('click', () => selectSubtitle('none'));
      subtitleOptions.appendChild(noneOption);
      
      // إضافة مسارات الترجمة المتاحة
      textTracks.forEach((track) => {
        const option = document.createElement("div");
        option.className = "custom-select-option";
        option.dataset.value = track.language;
        option.textContent = track.language.toUpperCase() + (track.role ? ` (${track.role})` : '');
        option.addEventListener('click', () => selectSubtitle(track.language));
        subtitleOptions.appendChild(option);
      });

      // تحديد الترجمة الافتراضية
      if (playerConfig.defaultSubtitle !== "none") {
        const hasArabicTrack = textTracks.some(t => t.language === 'ar' || t.language === 'ara');
        if (hasArabicTrack) {
          const arabicLang = textTracks.find(t => t.language === 'ar' || t.language === 'ara');
          if (arabicLang) {
            selectSubtitle(arabicLang.language);
          }
        } else if (textTracks.length > 0) {
          selectSubtitle(textTracks[0].language);
        }
      }
    }

    function selectSubtitle(language) {
      const subtitleOptions = document.getElementById("subtitle-options");
      
      // إزالة التحديد السابق
      subtitleOptions.querySelectorAll('.selected').forEach(opt => opt.classList.remove('selected'));
      
      if (language === 'none') {
        player.setTextTrackVisibility(false);
        subtitleOptions.querySelector('[data-value="none"]').classList.add('selected');
      } else {
        player.selectTextLanguage(language);
        player.setTextTrackVisibility(true);
        subtitleOptions.querySelector(`[data-value="${language}"]`).classList.add('selected');
      }
    }

    function setupQualityOptions() {
      const qualityOptions = document.getElementById("quality-options");
      const tracks = player.getVariantTracks();
      
      qualityOptions.innerHTML = '';
      
      // إضافة Auto
      const autoOption = document.createElement("div");
      autoOption.className = "custom-select-option selected";
      autoOption.dataset.value = "auto";
      autoOption.innerHTML = '<i class="fas fa-tv quality-icon auto-icon"></i>Auto';
      autoOption.addEventListener('click', () => selectQuality('auto'));
      qualityOptions.appendChild(autoOption);
      
      // إضافة جودات أخرى
      const uniqueHeights = [...new Set(tracks.map(t => t.height))].sort((a, b) => b - a);
      uniqueHeights.forEach(height => {
        const option = document.createElement("div");
        option.className = "custom-select-option";
        option.dataset.value = height;
        
        let iconClass = 'auto-icon';
        let label = height + 'p';
        
        if (height >= 2160) { iconClass = 'uhd-icon'; label = '4K'; }
        else if (height >= 1080) { iconClass = 'fhd-icon'; label = 'FHD'; }
        else if (height >= 720) { iconClass = 'hd-icon'; label = 'HD'; }
        else if (height >= 480) { iconClass = 'sd-icon'; label = 'SD'; }
        
        option.innerHTML = `<i class="fas fa-tv quality-icon ${iconClass}"></i>${label}`;
        option.addEventListener('click', () => selectQuality(height));
        qualityOptions.appendChild(option);
      });
    }

    function selectQuality(quality) {
      const qualityOptions = document.getElementById("quality-options");
      const currentQualityText = document.getElementById("current-quality-text");
      const currentQualityIcon = document.getElementById("current-quality-icon");
      
      // إزالة التحديد السابق
      qualityOptions.querySelectorAll('.selected').forEach(opt => opt.classList.remove('selected'));
      
      if (quality === 'auto') {
        player.configure({abr: {enabled: true}});
        currentQualityText.textContent = 'Auto';
        currentQualityIcon.className = 'fas fa-tv quality-icon auto-icon';
        qualityOptions.querySelector('[data-value="auto"]').classList.add('selected');
      } else {
        const tracks = player.getVariantTracks().filter(t => t.height === quality);
        if (tracks.length > 0) {
          player.configure({abr: {enabled: false}});
          player.selectVariantTrack(tracks[0]);
          
          let iconClass = 'auto-icon';
          let label = quality + 'p';
          
          if (quality >= 2160) { iconClass = 'uhd-icon'; label = '4K'; }
          else if (quality >= 1080) { iconClass = 'fhd-icon'; label = 'FHD'; }
          else if (quality >= 720) { iconClass = 'hd-icon'; label = 'HD'; }
          else if (quality >= 480) { iconClass = 'sd-icon'; label = 'SD'; }
          
          currentQualityText.textContent = label;
          currentQualityIcon.className = `fas fa-tv quality-icon ${iconClass}`;
          qualityOptions.querySelector(`[data-value="${quality}"]`).classList.add('selected');
        }
      }
    }

    function setupAudioOptions() {
      const audioOptions = document.getElementById("audio-options");
      const tracks = player.getVariantTracks();
      
      audioOptions.innerHTML = '';
      
      // إضافة خيار "بدون صوت مصاحب"
      const noneOption = document.createElement("div");
      noneOption.className = "custom-select-option selected";
      noneOption.dataset.value = "none";
      noneOption.textContent = "بدون صوت مصاحب";
      audioOptions.appendChild(noneOption);
      
      // إضافة مسارات الصوت المتاحة
      const audioLanguages = [...new Set(tracks.map(t => t.language))];
      audioLanguages.forEach(lang => {
        if (lang) {
          const option = document.createElement("div");
          option.className = "custom-select-option";
          option.dataset.value = lang;
          option.textContent = lang.toUpperCase();
          audioOptions.appendChild(option);
        }
      });
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      const video = document.getElementById('video');
      const playOverlay = document.getElementById('play-overlay');
      const playPauseBtn = document.getElementById('play-pause-btn');
      const fullscreenBtn = document.getElementById('fullscreen-btn');
      const soundBtn = document.getElementById('sound-btn');
      const progressContainer = document.getElementById('progress-container');

      // بدء التشغيل
      playOverlay.addEventListener('click', async () => {
        try {
          await video.play();
          isPlaying = true;
          playOverlay.style.display = 'none';
          playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
          showControls();
        } catch (error) {
          console.error('خطأ في التشغيل:', error);
        }
      });

      // تشغيل/إيقاف
      playPauseBtn.addEventListener('click', () => {
        if (video.paused) {
          video.play();
          isPlaying = true;
          playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        } else {
          video.pause();
          isPlaying = false;
          playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        }
        showControls();
      });

      // شاشة كاملة
      fullscreenBtn.addEventListener('click', () => {
        if (document.fullscreenElement) {
          document.exitFullscreen();
        } else {
          document.documentElement.requestFullscreen();
        }
      });

      // كتم/إلغاء كتم الصوت
      soundBtn.addEventListener('click', () => {
        video.muted = !video.muted;
        soundBtn.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
        showControls();
      });

      // شريط التقدم
      progressContainer.addEventListener('click', (e) => {
        if (video.duration) {
          const rect = progressContainer.getBoundingClientRect();
          const pos = (e.clientX - rect.left) / rect.width;
          video.currentTime = pos * video.duration;
        }
      });

      // إظهار التحكم عند الحركة
      document.addEventListener('mousemove', showControls);
      document.addEventListener('touchstart', showControls);

      // تحديث شريط التقدم
      video.addEventListener('timeupdate', updateProgress);

      // التحكم في التكبير
      document.getElementById('zoom-in-btn').addEventListener('click', () => {
        if (zoomLevel < MAX_ZOOM) {
          zoomLevel += ZOOM_STEP;
          updateVideoSize();
        }
      });

      document.getElementById('zoom-out-btn').addEventListener('click', () => {
        if (zoomLevel > MIN_ZOOM) {
          zoomLevel -= ZOOM_STEP;
          updateVideoSize();
        }
      });

      document.getElementById('reset-zoom-btn').addEventListener('click', () => {
        zoomLevel = isMobileWithZoom() ? DEFAULT_MOBILE_ZOOM : 1;
        updateVideoSize();
      });

      // إدارة القوائم المنسدلة
      document.querySelectorAll('.custom-select').forEach(select => {
        const button = select.querySelector('button');
        const options = select.querySelector('.custom-select-options');

        button.addEventListener('click', (e) => {
          e.stopPropagation();
          
          // إغلاق القوائم الأخرى
          document.querySelectorAll('.custom-select-options.show').forEach(opt => {
            if (opt !== options) opt.classList.remove('show');
          });
          
          options.classList.toggle('show');
          showControls();
        });
      });

      // إغلاق القوائم عند النقر خارجها
      document.addEventListener('click', () => {
        document.querySelectorAll('.custom-select-options.show').forEach(opt => {
          opt.classList.remove('show');
        });
      });

      // تهيئة المشغل
      initPlayer();
    });
  </script>
</body>
</html>
